{"version":3,"sources":["assets/script/app/game/GameUIController.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\r\nimport {GameProxy} from \"./GameProxy\";\r\nimport {ext} from \"../../../framework/extend/Extend\";\r\nimport Actions from \"../../../framework/actions/Actions\";\r\nimport {World} from \"../info/World\";\r\n\r\nconst {ccclass, property} = cc._decorator;\r\n\r\nlet GoldIconNodePos:cc.Vec2 = null;\r\n\r\n@ccclass\r\nexport default class GameUIController extends cc.Component {\r\n\r\n    @property(cc.Node)\r\n    supplyIconNode:cc.Node = null;\r\n\r\n    @property(cc.RichText)\r\n    lvLabels: [cc.RichText] = [];\r\n\r\n    @property(cc.ProgressBar)\r\n    gameProgressBar:cc.ProgressBar = null;\r\n\r\n    @property(cc.Label)\r\n    gameProgressLabel:cc.Label = null;\r\n\r\n    @property(cc.Label)\r\n    goldLabel:cc.Label = null;\r\n\r\n    @property(cc.Node)\r\n    goldIconNode:cc.Node = null;\r\n\r\n    @property(cc.Node)\r\n    goldLayer:cc.Node = null;\r\n\r\n    @property(cc.Node)\r\n    gameOverNode:cc.Node = null;\r\n\r\n    private getInactiveGoldIconNode():cc.Node{\r\n        let node:cc.Node = this.goldLayer.children.find(value => value.active == false);\r\n        if (node == null){\r\n            node = cc.instantiate(this.goldIconNode);\r\n            node.active = false;\r\n            this.goldLayer.addChild(node);\r\n        }\r\n        node.opacity = 255;\r\n        node.scale = 0.7;\r\n        return node;\r\n    }\r\n\r\n    updateGold(){\r\n        this.goldLabel.string = ext.shortFormat(GameProxy.goldCount);\r\n    }\r\n\r\n    onLoad () {\r\n        this.node.on(GameProxy.Event.KillEnemy, this.onKillEnemy, this);\r\n        this.node.on(GameProxy.Event.InitGame, this.onInitGame, this);\r\n        this.node.on(GameProxy.Event.StartGame, this.onStartGame, this);\r\n        this.supplyIconNode.runAction(cc.repeatForever(cc.sequence(cc.scaleTo(0.35, 0.91), cc.scaleTo(0.35, 1))));\r\n    }\r\n\r\n    onDestroy(){\r\n        this.node.off(GameProxy.Event.KillEnemy, this.onKillEnemy, this);\r\n        this.node.off(GameProxy.Event.InitGame, this.onInitGame, this);\r\n        this.node.off(GameProxy.Event.StartGame, this.onStartGame, this);\r\n    }\r\n\r\n    checkWin(){\r\n        if (GameProxy.isOver && GameProxy.killCount >= GameProxy.maxEnemyNum && this.goldLayer.children.every(value => value.active == false)){\r\n            console.log(\"金币飞完了，结算\");\r\n            this.gameOverNode.active = true;\r\n        }\r\n    }\r\n\r\n    onKillEnemy(enemy){\r\n        // console.log(\"======onKillEnemy====>\");\r\n        /** 分配金币 */\r\n        let totalGold = enemy.gold * GameProxy.goldMul;\r\n        let sigleGold = Math.floor(totalGold/enemy.goldIconFell);\r\n        let restGold = totalGold - sigleGold * enemy.goldIconFell;\r\n        let addFlag = false;\r\n        let moveSpeed = 1000;\r\n        /** 飞金币 */\r\n        let position = enemy.node.position.add(enemy.node.getParent().getParent().position);\r\n        if (enemy.goldIconFell < 5){\r\n            /** 每一个延迟0.1秒执行 */\r\n            /** 随机一个方向 */\r\n            let sub = GoldIconNodePos.sub(position);\r\n            let center = position.add(sub.mul(0.15));\r\n            let p = sub.normalize().rotate(-90*Math.PI/180);\r\n            // let duration = sub.mag()/moveSpeed;\r\n            let duration = 0.65;\r\n            let bLeft = (Math.random()*100)%2 === 1;\r\n            for (let i=0; i<enemy.goldIconFell; i++){\r\n                let left = i%2 === 0 ? bLeft : !bLeft;\r\n                let goldIcon = this.getInactiveGoldIconNode();\r\n                goldIcon.position = position;\r\n                goldIcon.active = true;\r\n                goldIcon.runAction(cc.speed(cc.sequence(cc.delayTime(i*0.1), cc.bezierTo(duration, [\r\n                    center.add(p.mul(300*(left?-1:1))),\r\n                    GoldIconNodePos,\r\n                    GoldIconNodePos\r\n                ]).easing(cc.easeCircleActionIn()), cc.callFunc(()=>{\r\n                    goldIcon.active = false;\r\n                    //加金币\r\n                    if (!addFlag){\r\n                        addFlag = true;\r\n                        GameProxy.goldCount += sigleGold + restGold;\r\n                    } else {\r\n                        GameProxy.goldCount += sigleGold;\r\n                    }\r\n                    this.updateGold();\r\n                    this.checkWin();\r\n                })), 1));\r\n            }\r\n        }else {\r\n            // console.log(\"Actions.boom===>\");\r\n            /** 像转盘一样炸开 */\r\n            let radius = 80;\r\n            let num = enemy.goldIconFell;\r\n            Actions.boom(()=>{\r\n                let node = this.getInactiveGoldIconNode();\r\n                node.active = true;\r\n                return node;\r\n            }, position, GoldIconNodePos, radius, num,moveSpeed, ()=>{\r\n                if (!addFlag){\r\n                    addFlag = true;\r\n                    GameProxy.goldCount += sigleGold + restGold;\r\n                } else {\r\n                    GameProxy.goldCount += sigleGold;\r\n                }\r\n                this.updateGold();\r\n                this.checkWin();\r\n            });\r\n        }\r\n        this.updateGameProgress();\r\n    }\r\n\r\n    onInitGame(){\r\n        this.lvLabels.forEach((value, index) => value.string = `<b><outline color=#1e1e1e width=3>${GameProxy.level-1+index}</outline></b>`);\r\n        if (GameProxy.level < 2){\r\n            this.lvLabels[0].node.getParent().active = false;\r\n        }\r\n        this.updateGameProgress();\r\n        this.updateGold();\r\n    }\r\n\r\n    onStartGame(){\r\n        GoldIconNodePos = this.goldLayer.convertToNodeSpaceAR(this.goldIconNode.convertToWorldSpaceAR(cc.v2()));\r\n    }\r\n\r\n    updateGameProgress(){\r\n        this.gameProgressBar.progress = GameProxy.killCount / GameProxy.maxEnemyNum;\r\n        this.gameProgressLabel.string = `剩余敌人：${Math.ceil(100 * (GameProxy.maxEnemyNum - GameProxy.killCount)/GameProxy.maxEnemyNum)}%`\r\n    }\r\n\r\n    // update (dt) {}\r\n}\r\n"]}