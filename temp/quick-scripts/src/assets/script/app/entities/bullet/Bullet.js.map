{"version":3,"sources":["assets/script/app/entities/bullet/Bullet.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\r\n\r\nimport {ExcelConfig} from \"../../../../framework/config/ExcelConfig\";\r\nimport {ExcelTableNames} from \"../../config/ExcelTableNames\";\r\nimport {World} from \"../../info/World\";\r\n\r\nconst {ccclass} = cc._decorator;\r\n\r\n\r\n/**\r\n * 普通子弹，单纯的一个碰撞体，移动一段距离后消失\r\n */\r\n@ccclass\r\nexport default class Bullet extends cc.Component {\r\n    bulletId = 0;\r\n\r\n    bThrought = false;\r\n\r\n    hurt = 0;\r\n\r\n    repel = 0;\r\n\r\n    stiff = 0;\r\n\r\n    moveDir = cc.v2();\r\n\r\n    private _collider:cc.Collider = null;\r\n\r\n    protected _contacts = [];\r\n\r\n\r\n    get contacts(): any[] {\r\n        return this._contacts;\r\n    }\r\n\r\n    get collider(): cc.Collider {\r\n        return this._collider;\r\n    }\r\n\r\n\r\n    onLoad(){\r\n        this._collider = this.getComponent(cc.Collider);\r\n        this.node.on(cc.Node.EventType.ROTATION_CHANGED, ()=>{\r\n            let dir = cc.v2(0, 1).rotate(cc.misc.degreesToRadians(-this.node.rotation));\r\n            this.moveDir.x = dir.x;\r\n            this.moveDir.y = dir.y;\r\n        });\r\n    }\r\n\r\n\r\n    init(id:number){\r\n        this.bulletId = id;\r\n        let config = ExcelConfig.getExcelTable(ExcelTableNames.Weapon)[this.bulletId%100-1];\r\n        this.bThrought = config['pierce'] === 1;\r\n        this.hurt = Math.floor(config['hurt']*World.My.armory.hurtMulOf(this.bulletId%100));\r\n        this.repel = config['repel'];\r\n        this.stiff = config['stiff'];\r\n    }\r\n\r\n    /** 让子弹飞 */\r\n    fly(dir:cc.Vec2, distance:number, speed:number){\r\n        this.node.rotation = 90 - cc.misc.radiansToDegrees(Math.atan2(dir.y, dir.x));\r\n        this.node.runAction(cc.sequence(cc.moveBy(distance/speed, dir.mul(distance)), cc.callFunc(()=>{\r\n            this.node.active = false;\r\n        })));\r\n    }\r\n\r\n    onEnable(){\r\n        window['GameBulletsController'].roleBullets.push(this);\r\n    }\r\n\r\n    onDisable(){\r\n        this.node.stopAllActions();\r\n        this._contacts.length = 0;\r\n        let gameBulletsController = window['GameBulletsController'];\r\n        gameBulletsController.roleBullets.splice(gameBulletsController.roleBullets.indexOf(this), 1);\r\n    }\r\n\r\n    protected getStrikePos(other, self):cc.Vec2{\r\n        let otherAABB = other.world.aabb;\r\n        let selfAABB = self.world.aabb;\r\n        // console.log(\"otherAABB==>\", otherAABB);\r\n        // console.log(\"selfAABB==>\", selfAABB);\r\n        // console.log(\"===================\");\r\n\r\n        /** 方法一 */\r\n        /** 取包围盒的面积做比较，决策碰撞点，播放碰撞动画\r\n         * 1.怪物比子弹大很多时就在子弹的位置播放\r\n         * 2.子弹比怪物大很多时在怪物的位置播放\r\n         * 3.大小差不多时取中点(小于0.5倍则取中点)\r\n         * */\r\n        // let rate = 1.5;\r\n        // let selfArea = self.world.aabb.width * self.world.aabb.height;\r\n        // let otherArea = other.world.aabb.width * other.world.aabb.height;\r\n        // let strikePos = cc.v2();\r\n        // if (selfArea > otherArea){\r\n        //     if (selfArea/otherArea > rate){\r\n        //         /** 取other节点的位置 */\r\n        //         strikePos = other.world.aabb.center;\r\n        //     } else {\r\n        //         /** 取中心点 */\r\n        //     }\r\n        // }else {\r\n        //     if (otherArea/selfArea > rate){\r\n        //         /** 取self节点的位置 */\r\n        //     } else {\r\n        //         /** 取中心点 */\r\n        //     }\r\n        // }\r\n        /** 方法二 */\r\n        /** 用aabb包围盒判断碰撞点 */\r\n        // let selfDir = selfAABB.center.sub(self.world.preAabb.center).normalize();\r\n        //虽然可以用子弹的移动方向与物体的点集做运算，计算出边界碰撞位置，但是子弹已经飞过了这个位置，再在其他位置播放击中效果更突兀.\r\n        /** 水平方向 */\r\n        let strikePos = cc.v2();\r\n        if (selfAABB.xMin >= otherAABB.xMin && selfAABB.xMax <= otherAABB.xMax){\r\n            strikePos.x = selfAABB.center.x;\r\n        }else if (selfAABB.xMax <= otherAABB.center.x && selfAABB.xMin < otherAABB.xMin){\r\n            strikePos.x = selfAABB.xMax;\r\n        }else if (selfAABB.xMin >= otherAABB.center.x && selfAABB.xMax > otherAABB.xMax){\r\n            strikePos.x = selfAABB.xMin;\r\n        }else {\r\n            strikePos.x = otherAABB.center.x;\r\n        }\r\n\r\n        /** 垂直方向 */\r\n        if (selfAABB.yMin >= otherAABB.yMin && selfAABB.yMax <= otherAABB.yMax){\r\n            strikePos.y = selfAABB.center.y;\r\n        }else if (selfAABB.yMax <= otherAABB.center.y && selfAABB.yMin < otherAABB.yMin){\r\n            strikePos.y = selfAABB.yMax;\r\n        }else if (selfAABB.yMin >= otherAABB.center.y && selfAABB.yMax > otherAABB.yMax){\r\n            strikePos.y = selfAABB.yMin;\r\n        }else {\r\n            strikePos.y = otherAABB.center.y;\r\n        }\r\n\r\n        return strikePos;\r\n    }\r\n\r\n    /** 创建strike */\r\n    strike(other, self){\r\n        let bulletStrike = window['GameBulletsController'].getInactiveBulletStrike(this.bulletId);\r\n        bulletStrike.node.active = true;\r\n        bulletStrike.node.position = this.getStrikePos(other, self);\r\n        bulletStrike.node.rotation = this.node.rotation;\r\n        bulletStrike.strike();\r\n    }\r\n\r\n    doRepeal(enemy, repel){\r\n        enemy.doRepel(this.moveDir, repel);\r\n    }\r\n\r\n    /**\r\n     * 当碰撞产生的时候调用\r\n     *  */\r\n    protected collisionEnemy(other, self){\r\n        this.strike(other, self);\r\n        let enemy = other.getComponent('Enemy');\r\n        /** 僵硬 */\r\n        if (this.stiff > 0){\r\n            enemy.doStiff(this.stiff);\r\n        }\r\n        /** 减速 */\r\n        enemy.doSpeedcut();\r\n        /** 击退效果 */\r\n        let subRepel = this.repel - enemy.unrepel;\r\n        // let subRepel = 10;\r\n        if (subRepel > 0){\r\n            // console.log(\"击退效果……。\");\r\n            this.doRepeal(enemy, subRepel);\r\n        }else if (enemy.enemyID < 7) {\r\n            enemy.playBeatenBack();\r\n        }\r\n\r\n        /** 飘血效果 */\r\n        let damage = this.hurt;\r\n        if (damage > 0){\r\n            enemy.hp -= damage;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 碰撞处理\r\n     * */\r\n    onCollisionEnter (other, self) {\r\n\r\n        this.collisionEnemy(other, self);\r\n\r\n        if (!this.bThrought){\r\n            this.node.active = false;\r\n        }\r\n\r\n        // console.log('子弹碰撞');\r\n    }\r\n\r\n    /**\r\n     * 当碰撞产生后，碰撞结束前的情况下，每次计算碰撞结果后调用\r\n     * */\r\n    onCollisionStay(other, self){\r\n\r\n    }\r\n\r\n    /** 当碰撞结束后调用 */\r\n    onCollisionExit(other, self){\r\n\r\n    }\r\n\r\n}\r\n\r\n\r\n"]}